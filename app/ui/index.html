<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FEN · Asistente</title>
  <style>
    /* ===================== Tema (oscuro por defecto) ===================== */
    :root{
      --bg:#0b0f1a;
      --fg:#e6eaf2;
      --muted:#98a2b3;
      --accent:#60a5fa;
      --ring:#60a5fa;

      --sheet: transparent;            /* “hoja” continua */
      --separator:#1c263f;             /* separador entre mensajes */
      --input-bg:#0f172a;              /* barra de entrada */
      --btn-fg:#081225;                /* texto del botón */
      --shadow:0 10px 30px rgba(0,0,0,.35);

      --grad1:#0f1b36; --grad2:#0b0f1a; --grad3:#0f1430;
      --scroll-track:#0b0f1a;
      --scroll-thumb:#223057;

      /* espacio real reservado al final para que nada quede “bajo” el composer */
      --composer-space: 220px;
    }
    :root[data-theme="light"]{
      --bg:#f7f8fb;
      --fg:#0b1020;
      --muted:#5b6474;
      --accent:#2563eb;
      --ring:#2563eb;

      --sheet: transparent;
      --separator:#e5e7eb;
      --input-bg:#ffffff;
      --btn-fg:#ffffff;
      --shadow:0 12px 30px rgba(16,24,40,.08);

      --grad1:#dbeafe; --grad2:#f7f8fb; --grad3:#e0e7ff;
      --scroll-track:#eef2ff;
      --scroll-thumb:#a5b4fc;
    }

    /* ===================== Base ===================== */
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, var(--grad1) 0, var(--bg) 40%),
        radial-gradient(1000px 600px at 90% 10%,  var(--grad3) 0, var(--bg) 50%) fixed;
      color:var(--fg);
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      transition: background .25s ease, color .2s ease;
      overflow-y: overlay; /* para que el scroll no empuje el contenido */
    }
    /* Scrollbar bonito (Chromium/WebKit) */
    ::-webkit-scrollbar{ width: 12px }
    ::-webkit-scrollbar-track{ background: var(--scroll-track) }
    ::-webkit-scrollbar-thumb{ background: var(--scroll-thumb); border-radius: 8px }
    ::-webkit-scrollbar-thumb:hover{ filter: brightness(1.2) }
    /* Firefox */
    *{ scrollbar-width: thin; scrollbar-color: var(--scroll-thumb) var(--scroll-track) }

    .wrap{ min-height:100%; display:flex; flex-direction:column }

    header{
      padding:12px 16px;
      display:flex; justify-content:flex-end; align-items:center; gap:8px;
    }
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--separator);
      background: var(--input-bg); color:var(--fg);
      border-radius:999px; cursor:pointer; font-size:13px;
      box-shadow: var(--shadow);
    }

    .hero{ text-align:center; padding: 8px 16px 10px }
    .hello{
      margin:10px 0 2px;
      font-size:44px; font-weight:800; letter-spacing:.2px;
      background:linear-gradient(90deg,#8ab4ff,#a78bfa,var(--accent));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    :root[data-theme="light"] .hello{
      background:linear-gradient(90deg,#1d4ed8,#7c3aed,#2563eb);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .sub{ color:var(--muted); margin:0 auto; max-width:820px }

    /* ===================== “Hoja” de conversación ===================== */
    .sheet{
      width:min(900px,92vw);
      margin: 10px auto 0;
      padding-bottom: var(--composer-space);  /* reserva para que nada quede tapado */
      background: var(--sheet);
    }
    .row{ padding: 18px 6px; border-bottom:1px solid var(--separator) }
    .row:last-child{ border-bottom: none }
    .role{ font-size:12px; color:var(--muted); letter-spacing:.6px; margin-bottom:6px }
    .content{ white-space: pre-wrap }
    .row.ai .content{ text-shadow: 0 0 0 transparent }

    /* loader inline */
    .loader{ display:inline-flex; gap:6px; align-items:center; color:var(--muted) }
    .dots{ display:inline-flex; gap:6px; margin-right:6px }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); opacity:.7; animation:bounce 1s infinite }
    .dot:nth-child(2){ animation-delay:.15s }
    .dot:nth-child(3){ animation-delay:.3s }
    @keyframes bounce{ 0%,80%,100%{transform:translateY(0); opacity:.35} 40%{transform:translateY(-6px); opacity:1} }

    /* ===================== Máscara para cubrir detrás del composer ===================== */
    .bottom-mask{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--composer-space);
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(11,15,26,0) 0%,
        rgba(11,15,26,0.75) 45%,
        var(--bg) 100%
      );
      z-index: 9;
    }
    :root[data-theme="light"] .bottom-mask{
      background: linear-gradient(
        to bottom,
        rgba(247,248,251,0) 0%,
        rgba(247,248,251,0.85) 45%,
        var(--bg) 100%
      );
    }

    /* ===================== Composer fijo abajo ===================== */
    .composer{
      position:fixed; left:0; right:0; bottom:28px;
      display:flex; flex-direction:column; align-items:center; gap:8px; z-index:10;
      padding:0 12px;
    }
    .askbar{
      width:min(900px,92vw); display:flex; gap:10px; align-items:center;
      background:var(--input-bg); border:1px solid var(--separator);
      border-radius:999px; padding:10px 12px; box-shadow:var(--shadow);
      backdrop-filter: saturate(120%) blur(6px);
    }
    .askbar:focus-within{ outline:2px solid var(--ring); outline-offset:2px }
    .askbar input{
      flex:1; border:none; background:transparent; color:var(--fg); font-size:16px;
      padding:12px 14px; outline:none;
    }
    .send{
      height:44px; border:none; border-radius:999px; padding:0 18px; font-weight:700;
      background:var(--accent); color:var(--btn-fg); cursor:pointer;
    }
    :root[data-theme="light"] .send{ color:#ffffff }
    .send:disabled{ opacity:.6; cursor:not-allowed }
    .hint{ color:var(--muted); font-size:12px; text-align:center }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <button id="toggleTheme" class="toggle" title="Cambiar tema">
      <span id="toggleIcon"></span><span id="toggleText">Oscuro</span>
    </button>
  </header>

  <section class="hero">
    <h1 class="hello" id="hello">Hola, Gustavo</h1>
    <p class="sub" id="subtitle">Pregúntame algo sobre la base de conocimiento.</p>
  </section>

  <!-- Hoja continua -->
  <div id="sheet" class="sheet"></div>

  <!-- Máscara que tapa lo de atrás del composer -->
  <div class="bottom-mask" aria-hidden="true"></div>

  <!-- Composer -->
  <div class="composer">
    <div class="askbar" role="search">
      <input id="q" type="text" placeholder="Escribe tu pregunta…" aria-label="Pregunta" />
      <button id="send" class="send">Enviar</button>
    </div>
    <div class="hint">Si no hay soporte en documentos, responderé: “No tengo información suficiente…”.</div>
  </div>
</div>

<script>
  // ============ CONFIG ============
  const ENDPOINT  = '/chat/invoke';   // Cambia a '/agent/invoke' para el agente
  const USER_NAME = '';

  // ============ UI refs ============
  const $hello   = document.getElementById('hello');
  const $sheet   = document.getElementById('sheet');
  const $q       = document.getElementById('q');
  const $send    = document.getElementById('send');

  // saludo dinámico
  const h = new Date().getHours();
  const saludo = h<12?'Buenos días': h<19?'Buenas tardes':'Buenas noches';
  $hello.textContent = `Hola, ${saludo}`;
  document.getElementById('subtitle').textContent = `Preguntame algo de Procesamiento de OV, Facturación / Cobranzas, Selección y Contratación del Personal de KSB`;

  // historial que también se envía al backend si usas /agent/invoke
  const messages = []; // { type:'human'|'ai', content:string }

  // helpers
  function escapeHtml(str){
    return (str ?? '').toString().replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }
  function scrollBottom(){
    const el = document.scrollingElement || document.documentElement;
    window.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
  }
  function addRow(role, text, {withLoader=false} = {}){
    const row = document.createElement('div');
    row.className = `row ${role}`;
    row.innerHTML = `
      <div class="role">${role.toUpperCase()}</div>
      <div class="content">${escapeHtml(text || '')}</div>
    `;
    if (withLoader) {
      const loader = document.createElement('div');
      loader.className = 'loader';
      loader.innerHTML = `<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span><em>Pensando…</em>`;
      row.querySelector('.content').appendChild(loader);
      row.setAttribute('data-loading', '1');
    }
    $sheet.appendChild(row);
    scrollBottom();
    return row;
  }
  function stopLoader(row){
    if (!row) return;
    const loader = row.querySelector('.loader');
    if (loader) loader.remove();
    row.removeAttribute('data-loading');
  }
  function setRowText(row, text){
    const cont = row.querySelector('.content');
    cont.innerHTML = escapeHtml(text || '');
  }

  async function askBackend(q){
    const payload = { input: { input: q, messages } }; // LangServe /invoke
    const res = await fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    // LangServe /invoke: { output: "..." } u objeto con {answer: "..."}
    return (typeof data.output === 'string')
      ? data.output
      : (data.output?.answer ?? JSON.stringify(data.output));
  }

  // ============ Envío con limpieza inmediata del input ============  
  async function onSend(){
    const text = $q.value.trim();
    if (!text) return;

    // limpiar input y mostrar placeholder temporal
    const prevPlaceholder = $q.placeholder;
    $q.value = '';
    $q.placeholder = 'Enviando…';
    $send.disabled = true;

    // pintar enseguida en la hoja
    addRow('Pregunta', text);
    const aiRow = addRow('Respuesta', '', {withLoader:true});

    // acumular historial (sirve para /agent/invoke)
    messages.push({ type:'Pregunta', content:text });

    try{
      const out = await askBackend(text);
      messages.push({ type:'Respuesta', content: out });

      stopLoader(aiRow);
      setRowText(aiRow, out);
    }catch(e){
      stopLoader(aiRow);
      setRowText(aiRow, `Error: ${e.message || e}`);
    }finally{
      $send.disabled = false;
      $q.placeholder = prevPlaceholder;
      $q.focus();
      scrollBottom();
    }
  }

  $send.addEventListener('click', onSend);
  $q.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); onSend(); }
  });

  // ============ Tema claro/oscuro (persistente) ============
  const THEME_KEY = 'fen_ui_theme';
  const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
  const savedTheme = localStorage.getItem(THEME_KEY) || (prefersLight ? 'light' : 'dark');

  function setTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem(THEME_KEY, t);
    const iconMoon = '<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>';
    const iconSun  = '<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.48 0l1.79-1.8 1.41 1.41-1.8 1.79-1.4-1.4zM12 4h0V1h0v3zm0 19h0v-3h0v3zM4 12H1v0h3zm19 0h-3v0h3zM6.76 19.16l-1.42 1.42-1.79-1.8 1.41-1.41 1.8 1.79zm10.48 0l1.4 1.4 1.8-1.79-1.41-1.41-1.79 1.8zM12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>';
    document.getElementById('toggleIcon').innerHTML = (t === 'dark') ? iconMoon : iconSun;
    document.getElementById('toggleText').textContent = (t === 'dark') ? 'Oscuro' : 'Claro';
  }
  setTheme(savedTheme);

  document.getElementById('toggleTheme').addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    setTheme(current === 'dark' ? 'light' : 'dark');
  });
</script>
</body>
</html>
